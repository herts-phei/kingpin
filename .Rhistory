group_by(pin_name) %>%
mutate(projects_read_conc = paste(project_name, collapse = "|")) %>%
ungroup()
View(project_read)
project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(pin_name, project_name) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(projects_read_conc = paste(project_name, collapse = "|")) %>%
ungroup()
View(project_read)
project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(pin_name, project_name) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(projects_read_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
View(project_read)
pins <- record_level %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1),
writer_count = ifelse(is.na(writer), 0, 1)) %>%
group_by(pin_name) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
write_instances = sum(writer_count),
last_write = max(as.Date(write_date), na.rm = TRUE),
comment = comment,
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"),
last_write = as.Date(ifelse(last_write == -Inf, NA, last_write),
origin = "1970-01-01"))
pins <- pins %>%
left_join(read_interval, by = c("pin_name" = "pin_name")) %>%
left_join(write_interval, by = c("pin_name" = "pin_name")) %>%
left_join(project_read, by = c("pin_name" = "pin_name"))
View(pins)
# USERS
users_read <- record_level %>%
filter(!is.na(reader)) %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1)) %>%
group_by(reader) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"))
user_read <- record_level %>%
filter(!is.na(reader)) %>%
select(pin_name, reader) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(projects_read_conc = paste(reader, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
user_read <- record_level %>%
filter(!is.na(reader)) %>%
select(pin_name, reader) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(projects_read_conc = paste(reader, collapse = "|")) %>%
ungroup() %>%
select(-reader) %>%
distinct()
View(user_read)
project_write <- record_level %>%
filter(!is.na(writer)) %>%
select(pin_name, project_name) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(projects_write_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
View(project_write)
user_write <- record_level %>%
filter(!is.na(writer)) %>%
select(pin_name, writer) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(users_write_conc = paste(writer, collapse = "|")) %>%
ungroup() %>%
select(-writer) %>%
distinct()
user_read <- record_level %>%
filter(!is.na(reader)) %>%
select(pin_name, reader) %>%
distinct() %>%
group_by(pin_name) %>%
mutate(users_read_conc = paste(reader, collapse = "|")) %>%
ungroup() %>%
select(-reader) %>%
distinct()
pins <- record_level %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1),
writer_count = ifelse(is.na(writer), 0, 1)) %>%
group_by(pin_name) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
write_instances = sum(writer_count),
last_write = max(as.Date(write_date), na.rm = TRUE),
comment = comment,
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"),
last_write = as.Date(ifelse(last_write == -Inf, NA, last_write),
origin = "1970-01-01"))
pins <- pins %>%
left_join(read_interval, by = c("pin_name" = "pin_name")) %>%
left_join(write_interval, by = c("pin_name" = "pin_name")) %>%
left_join(project_read, by = c("pin_name" = "pin_name")) %>%
left_join(user_read, by = c("pin_name" = "pin_name")) %>%
left_join(project_write, by = c("pin_name" = "pin_name")) %>%
left_join(user_write, by = c("pin_name" = "pin_name"))
View(pins)
View(project_read)
users_project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(reader, project_name) %>%
distinct() %>%
group_by(reader) %>%
mutate(projects_read_conc = paste(reader, collapse = "|")) %>%
ungroup() %>%
select(-reader) %>%
distinct()
View(users_project_read)
users_project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(reader, project_name) %>%
distinct() %>%
group_by(reader) %>%
mutate(projects_read_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-reader) %>%
distinct()
View(users_project_read)
users_project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(reader, project_name) %>%
distinct() %>%
group_by(reader) %>%
mutate(projects_read_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
View(users_project_read)
users_project_write <- record_level %>%
filter(!is.na(writer)) %>%
select(writer, project_name) %>%
distinct() %>%
group_by(writer) %>%
mutate(users_write_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
View(users_project_write)
users_project_read <- record_level %>%
filter(!is.na(reader)) %>%
select(reader, project_name) %>%
distinct() %>%
group_by(reader) %>%
mutate(users_read_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
users_project_write <- record_level %>%
filter(!is.na(writer)) %>%
select(writer, project_name) %>%
distinct() %>%
group_by(writer) %>%
mutate(users_write_conc = paste(project_name, collapse = "|")) %>%
ungroup() %>%
select(-project_name) %>%
distinct()
View(user_write)
# USERS
users_read <- record_level %>%
filter(!is.na(reader)) %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1)) %>%
group_by(reader) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"))
View(users_read)
if(nrow(users_read) > nrow(users_write)) { users <- users_read } else { users <- users_write }
if(nrow(users_read) > nrow(users_write)) {
users <- rename(users_read, user = reader)
} else {
users <- rename(users_write , user = writer)
}
View(users)
if(nrow(users_read) > nrow(users_write)) {
users <- rename(users_read, user = reader) %>%
left_join(users_write, by = c("user" = "writer"))
} else {
users <- rename(users_write , user = writer) %>%
left_join(users_read, by = c("user" = "reader"))
}
View(users)
users_project_read
if(nrow(users_read) > nrow(users_write)) {
users <- rename(users_read, user = reader) %>%
left_join(users_write, by = c("user" = "writer"))
} else {
users <- rename(users_write , user = writer) %>%
left_join(users_read, by = c("user" = "reader"))
}
users <- users %>%
left_join(users_project_read, by = c("user" = "reader")) %>%
left_join(users_project_write, by = c("user" = "writer"))
View(users)
# PROJECTS
projects_read <- record_level %>%
filter(!is.na(reader)) %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1)) %>%
group_by(project_name) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"))
View(projects_read)
projects_write <- record_level %>%
filter(!is.na(writer)) %>%
mutate(writer_count = ifelse(is.na(writer), 0, 1)) %>%
group_by(project_name) %>%
summarise(write_instances = sum(writer_count),
last_write = max(as.Date(write_date), na.rm = TRUE),
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_write = as.Date(ifelse(last_write == -Inf, NA, last_write),
origin = "1970-01-01"))
View(projects_write)
View(pins)
project_pins_read <- record_level %>%
filter(!is.na(reader)) %>%
select(project_name, pin_name) %>%
distinct() %>%
group_by(project_name) %>%
mutate(project_read_conc = paste(pin_name, collapse = "|")) %>%
ungroup() %>%
select(-pin_name) %>%
distinct()
View(project_pins_read)
project_pins_write <- record_level %>%
filter(!is.na(writer)) %>%
select(project_name, pin_name) %>%
distinct() %>%
group_by(project_name) %>%
mutate(project_write_conc = paste(pin_name, collapse = "|")) %>%
ungroup() %>%
select(-pin_name) %>%
distinct()
View(project_pins_write)
if(nrow(project_read) > nrow(project_write)) {
projects <- project_read %>%
left_join(project_write, by = c("project_name" = "project_name"))
} else {
projects <- project_write %>%
left_join(project_read, by = c("project_name" = "project_name"))
}
if(nrow(project_read) > nrow(project_write)) {
projects <- project_read %>%
left_join(project_write, by = c("project_name" = "project_name"))
} else {
projects <- project_write %>%
left_join(project_read, by = c("project_name" = "project_name"))
}
View(project_pins_read)
if(nrow(projects_read) > nrow(projects_write)) {
projects <- projects_read %>%
left_join(projects_write, by = c("project_name" = "project_name"))
} else {
projects <- projects_write %>%
left_join(projects_read, by = c("project_name" = "project_name"))
}
View(projects)
projects <- projects %>%
left_join(project_pins_read, by = c("project_name" = "project_name")) %>%
left_join(project_pins_write, by = c("project_name" = "project_name"))
View(projects)
l <- list(pin_summary = pins,
user_summary = users,
project_summary = projects)
View(l)
kingpin::pin_throw(board, l, "kingpin_summary", comment = "Summary data for kingpin's data: Includes pin summary, user summary, and project summary.")
kingpin::pin_throw(board, l, "kingpin_summary",
comment = "Summary data for kingpin's data: Includes pin summary, user summary, and project summary.")
kingpin::pin_throw(board, l, "ayu/kingpin_summary",
comment = "Summary data for kingpin's data: Includes pin summary, user summary, and project summary.")
kingpin::pin_throw(board, l, name = "ayu/kingpin_summary",
comment = "Summary data for kingpin's data: Includes pin summary, user summary, and project summary.")
pins::pin_write(board, l, name = "kingpin_summary")
View(pins)
pins <- record_level %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1),
writer_count = ifelse(is.na(writer), 0, 1)) %>%
group_by(pin_name) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
write_instances = sum(writer_count),
last_write = max(as.Date(write_date), na.rm = TRUE),
comment = comment,
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"),
last_write = as.Date(ifelse(last_write == -Inf, NA, last_write),
origin = "1970-01-01"))
read_interval <- record_level %>%
filter(!is.na(reader)) %>%
group_by(pin_name) %>%
mutate(read_interval = lead(as.Date(read_date)) - as.Date(read_date)) %>%
filter(read_interval != 0) %>%
summarise(median_read_interval = as.numeric(median(read_interval)),
mean_read_interval = as.numeric(mean(read_interval))) %>%
ungroup()
View(read_interval)
write_interval <- record_level %>%
filter(!is.na(writer)) %>%
group_by(pin_name) %>%
mutate(write_interval = lead(as.Date(write_date)) - as.Date(write_date)) %>%
filter(write_interval != 0) %>%
summarise(median_write_interval = as.numeric(median(write_interval)),
mean_write_interval = as.numeric(mean(write_interval))) %>%
ungroup()
pins <- pins %>%
left_join(read_interval, by = c("pin_name" = "pin_name")) %>%
left_join(write_interval, by = c("pin_name" = "pin_name")) %>%
left_join(project_read, by = c("pin_name" = "pin_name")) %>%
left_join(user_read, by = c("pin_name" = "pin_name")) %>%
left_join(project_write, by = c("pin_name" = "pin_name")) %>%
left_join(user_write, by = c("pin_name" = "pin_name")) %>%
# Users -------------------------------------------------------------------
users_read <- record_level %>%
filter(!is.na(reader)) %>%
mutate(reader_count = ifelse(is.na(reader), 0, 1)) %>%
group_by(reader) %>%
summarise(read_instances = sum(reader_count),
last_read = max(as.Date(read_date), na.rm = TRUE),
.groups = "drop") %>%
distinct() %>%
dplyr::mutate(last_read = as.Date(ifelse(last_read == -Inf, NA, last_read),
origin = "1970-01-01"))
pins <- pins %>%
left_join(read_interval, by = c("pin_name" = "pin_name")) %>%
left_join(write_interval, by = c("pin_name" = "pin_name")) %>%
left_join(project_read, by = c("pin_name" = "pin_name")) %>%
left_join(user_read, by = c("pin_name" = "pin_name")) %>%
left_join(project_write, by = c("pin_name" = "pin_name")) %>%
left_join(user_write, by = c("pin_name" = "pin_name"))
kingpin::pin_throw(board, l, name = "kingpin_summary",
comment = "Kingpin summary data: Pins, users, projects")
l <- list(pin_summary = pins,
user_summary = users,
project_summary = projects)
kingpin::pin_throw(board, l, name = "kingpin_summary",
comment = "Kingpin summary data: Pins, users, projects")
# Clean kingpin data
kingpin <- data.frame(pin_name = "kingpin", # pin name
project_name = "none", # name of project associated with pin, if applicable
writer = Sys.info()["user"], # username of pin_write instance
write_date = Sys.time(), # date of pin_write instance
reader = NA, # username of pin_read instance
read_date = NA, # date of pin_read instance
comment = "Kingpin holding pin usage data")
kingpin::pin_throw(board, kingpin, name = "kingpin",
comment = "Kingpin holding pin usage data")
library(testthat)
library(kingpin)
test_check("kingpin")
test()
devtools::check()
# Pinning -----------------------------------------------------------------
t = pins::pin_read(board, "ayu/kingpin")
View(t)
# Clean kingpin data
kingpin <- list(
records = data.frame(pin_name = "kingpin", # pin name
project_name = "none", # name of project associated with pin, if applicable
writer = Sys.info()["user"], # username of pin_write instance
write_date = Sys.time(), # date of pin_write instance
reader = NA, # username of pin_read instance
read_date = NA, # date of pin_read instance
comment = "Kingpin holding pin usage data"
))
kingpin::pin_throw(board, kingpin, name = "kingpin",
comment = "Kingpin holding pin usage data")
# Pinning -----------------------------------------------------------------
t = pins::pin_read(board, "ayu/kingpin")
View(t)
pin_throw(iris, "test_again")
pin_throw(board, iris, "test_again")
pin_return(board,  "kingpin")
pin_return(board,  "kingpin")$records
board <- pins::board_rsconnect(server = Sys.getenv("CONNECT_SERVER"), key = Sys.getenv("CONNECT_API_KEY"))
name = "kingpin"
# Clean pin name
name <- sub('.*/', '', name)
# Get active project
call <- purrr::safely(rstudioapi::getActiveProject)()
if(is.null(call$result) | !is.null(call$error)) { # If not in a project or not in a session
project <- "none"
} else {
project <- sub('.*/', '', rstudioapi::getActiveProject())
}
# Check if user has access to the pin
content <- suppressMessages(purrr::safely(pins::pin_read)(board, name, ...))
# Check if user has access to the pin
content <- suppressMessages(purrr::safely(pins::pin_read)(board, name))
size(content)
object.size(content)
board <- kingpin::board_rsconnect(Sys.getenv("CONNECT_SERVER"), Sys.getenv("CONNECT_API_KEY"))
old_info <- suppressMessages(purrr::safely(pins::pin_meta)(board, "yphws_lookup"))
View(old_info)
board <- pins::board_rsconnect(server = Sys.getenv("CONNECT_SERVER"), key = Sys.getenv("CONNECT_API_KEY"))
name = "sbeal/stom"
# Clean pin name
name <- sub('.*/', '', name)
name
# Get active project
call <- purrr::safely(rstudioapi::getActiveProject)()
call
?rstudioapi::getActiveProject
is.null(call$result) | !is.null(call$error)
project <- sub('.*/', '', rstudioapi::getActiveProject())
project
# Check if user has access to the pin
content <- suppressMessages(purrr::safely(pins::pin_read)(board, name, ...))
content
# Check if user has access to the pin
content <- suppressMessages(purrr::safely(pins::pin_read)(board, name))
content
# Check if there's a comment
comment <- ifelse(is.null(comment(content$result)), NA, comment(content$result))
comment
# Update kingpin
kingpin <- purrr::quietly(pins::pin_read)(board, "kingpin")$result
kingpin$records <- kingpin$records |>
dplyr::bind_rows(data.frame(pin_name = name, # pin name
project_name = project, # name of project associated with pin, if applicable
writer = NA, # username of pin_write instance
write_date = NA, # date of pin_write instance
reader = Sys.info()["user"], # username of pin_read instance
read_date = as.character(Sys.time()), # date of pin_read instance
last_modified = NA,
comment = comment
))
View(kingpin)
t=kingpin$records
View(t)
file=iris
name = "iris_test"
comment = "Temporary testing"
# Clean pin name
name <- sub('.*/', '', name)
name
# Adding comments
if (is.null(comment)) { # if not specified
# Add comment if it already exists
if(!is.null(comment(file))) comment <- comment(file)
# OR add comment if it already exists from the previous version of the pin (high priority)
pin_prev <- suppressMessages(purrr::safely(pins::pin_read)(board, name))
if(is.null(pin_prev$error)) { comment <- comment(pin_prev$result) }
} else { # if specified
# Add comment
comment(file) <- comment
}
comment(file)
# If comment is still NULL:
if (is.null(comment)) {
message("Pin will be pinned with no description. Please consider adding a description using the `comment` argument.")
comment <- NA } else { # If comment is not NULL
cat("Pinned", name, "with the description '", comment(file), "'.")
}
# Get active project
call <- purrr::safely(rstudioapi::getActiveProject)()
if(is.null(call$result) | !is.null(call$error)) { # If not in a project or not in a session
project <- "none"
} else {
project <- sub('.*/', '', rstudioapi::getActiveProject())
}
# Get active project
call <- purrr::safely(rstudioapi::getActiveProject)()
old_info <- suppressMessages(purrr::safely(pins::pin_meta)(board, name))
old_info
call$result
# Write pin and check if user has access to the pin
access <- suppressMessages(purrr::safely(pins::pin_write)(board, file, name, ...))
# Write pin and check if user has access to the pin
access <- suppressMessages(purrr::safely(pins::pin_write)(board, file, name))
access
new_info <- suppressMessages(purrr::safely(pins::pin_meta)(board, name))
new_info
new_info$result$file_size == old_info$result$file_size
if(new_info$result$file_size == old_info$result$file_size){
modified = NA
} else {
modified = Sys.time()
}
